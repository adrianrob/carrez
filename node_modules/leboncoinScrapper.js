var fs=require('fs');
var scrap=require('scrap');


exports.initScrap =  function (req,res)
{
  if(typeof(req.session.json)=='undefined')
  {

    req.session.json=
    {
      title:"", // nom annonce
      price:"", // prix    ( /mois si loc)
      surface : "",
      rooms:"",
      code:"",
      city:"",
      type:"", // vente / loc
      type2:"",  // appart, maison
      urlimg:"",
      urlMA:"" ,  // url de meilleursagents a scrapper
      coutm2:"",
      pricelow:"",      //  |
      pricemedium:"",   //  | ->   pour le scrap de meilleursagents
      pricehigh:"",     //  |
      bilan:""
    };
  }
    res.render('accueil.ejs');
}



exports.postAndScrap = function (req,res)
{
      var url = req.body.urltoscrap;
      if(url.length < 1)
      {
        url = "http://www.leboncoin.fr/ventes_immobilieres/918855136.htm?ca=12_s";
      }

      scrap(url,function(err,$)
      {
      var data = $('body').children().first().text();
      console.log('data : '+data);

      req.session.json.title=$('#ad_subject').text();
      req.session.json.price = getProp("prix",data);
      req.session.json.surface = getProp("surface",data);
      req.session.json.coutm2 = parseInt(req.session.json.price) / parseInt(req.session.json.surface);
      req.session.json.rooms = getProp("pieces",data);
      req.session.json.code = getProp("cp",data);
      req.session.json.city = getProp("city",data);
      req.session.json.type = getProp("subcat",data);
      if(req.session.json.type == "locations")
      {
        req.session.json.price = getProp("loyer",data);
      }
      req.session.json.type2 = getProp(" type",data);
      req.session.json.urlimg=$('.lbcImages').children().first().attr('content');
      req.session.json.urlMA = 'https://www.meilleursagents.com/prix-immobilier/'+req.session.json.city + '-'+req.session.json.code+'/#estimates';

    //  console.log(req.session.json);
      res.redirect('/scrapMA');
    });
  }


  function getProp(prop,chaine)
  {
    var mot = prop+" : ";
    var position_debut = chaine.indexOf(mot);
    var position_fin= chaine.indexOf('",',position_debut);
    var longueur = position_fin-(position_debut+(mot.length));
    return chaine.substr(position_debut+(mot.length)+1,longueur-1);
  }
