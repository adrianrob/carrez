var fs=require('fs');
var scrap=require('scrap');


exports.scrapMA = function(req,res)
{
    console.log('url : '+req.session.json.urlMA);
    var pl = '';
    var pm ='';
    var ph = '';

      scrap(req.session.json.urlMA ,function(err,$)
      {
            if(req.session.json.type == "ventes_immobilieres")
            {
              console.log("this is a sale");
                if(req.session.json.type2 == "appartement")
                {
                  console.log("this is a flat");
                    pl = $('#synthese').children().first().children().first().children().next().children().next().text();
                    pm = $('#synthese').children().first().children().first().children().next().children().next().next().text();
                    ph = $('#synthese').children().first().children().first().children().next().children().next().next().next().text();
                }
                else
                {
                  console.log("this is a house");
                  pl = $('#synthese').children().first().children().first().children().next().next().children().next().text();;
                  pm = $('#synthese').children().first().children().first().children().next().next().children().next().next().text();
                  ph = $('#synthese').children().first().children().first().children().next().next().children().next().next().next().text();
                }
            }
            else
            {
                console.log("this is a rent");
                pl = $('#synthese').children().first().children().first().children().next().next().next().children().next().text();;
                pm = $('#synthese').children().first().children().first().children().next().next().next().children().next().next().text();
                ph = $('#synthese').children().first().children().first().children().next().next().next().children().next().next().next().text();
            }

              console.log("\n\nError : "+err+"\n\n");
              //console.log($('body').text());


            req.session.json.pricelow = pl.replace(new RegExp('[^0-9]','g'),'');
            req.session.json.pricemedium = pm.replace(new RegExp('[^0-9]','g'),'');
            req.session.json.pricehigh = ph.replace(new RegExp('[^0-9]','g'),'');

            if(parseInt(req.session.json.coutm2) > parseInt(req.session.json.pricemedium))
            {
              if(parseInt(req.session.json.coutm2) > parseInt(req.session.json.pricehigh))
              {
                  req.session.json.bilan = "TM";
              }
              else
              {
                  req.session.json.bilan = "M";
              }
            }
            else
            {
              if(parseInt(req.session.json.coutm2) > parseInt(req.session.json.pricelow))
              {
                  req.session.json.bilan = "B";
              }
              else
              {
                  req.session.json.bilan = "TB";
              }
            }


            console.log(req.session.json);
            res.render('results.ejs',{mydata:req.session.json});
      });
}
